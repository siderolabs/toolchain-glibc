name: linux-headers
variant: debian
install:
  - make
  - rsync
  - xz-utils
dependencies:
  - stage: bootstrap
steps:
  - sources:
      - url: https://cdn.kernel.org/pub/linux/kernel/v{{ regexReplaceAll ".\\d+\\.\\d+$" .linux_version "${1}" }}.x/linux-{{ .linux_version }}.tar.xz
        destination: linux.tar.xz
        sha256: "{{ .linux_sha256 }}"
        sha512: "{{ .linux_sha512 }}"
    env:
      PATH: "{{ .BOOTSTRAP }}/bin:{{ .PATH }}"
    prepare:
      - |
        tar -xJf linux.tar.xz --strip-components=1
    build:
      - |
        arch=""

        case $ARCH in
            x86_64)
                arch="x86_64"
            ;;
            aarch64)
                arch="arm64"
            ;;
            armv7)
                arch="arm"
            ;;
            *)
                echo "unsupported arch ${ARCH}"
                exit 1
            ;;
        esac

        make -j $(nproc) headers ARCH=${arch}
    install:
      - |
        make headers_install INSTALL_HDR_PATH=${TOOLCHAIN}
finalize:
  - from: "{{ .TOOLCHAIN }}"
    to: "{{ .TOOLCHAIN }}"
